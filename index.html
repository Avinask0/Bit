import React, { useState, useEffect } from 'react';
import { AlertCircle, Wallet, ArrowDownUp, TrendingUp, RefreshCw } from 'lucide-react';

// Contract ABIs (simplified - only essential functions)
const BINR_ABI = [
  "function mint(uint256 usdcAmount, uint256 minTokensOut) external",
  "function burn(uint256 tokenAmount, uint256 minUsdcOut) external",
  "function balanceOf(address account) view returns (uint256)",
  "function totalSupply() view returns (uint256)",
  "function getLatestPrice() view returns (uint256)",
  "function pricePerTokenInUsdc() view returns (uint256)",
  "function collectedFees() view returns (uint256)",
  "function getTotalValue() view returns (uint256)",
  "function getYieldGenerated() view returns (uint256)",
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)"
];

const ERC20_ABI = [
  "function balanceOf(address account) view returns (uint256)",
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function decimals() view returns (uint8)"
];

const BINR_ADDRESS = "0x7Ab8c3947590908FDcfC6321fFfD240e1B81f2B5";
const USDC_ADDRESS = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; // Polygon USDC

export default function BINRDApp() {
  const [account, setAccount] = useState(null);
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [binrContract, setBinrContract] = useState(null);
  const [usdcContract, setUsdcContract] = useState(null);
  
  // Balances
  const [binrBalance, setBinrBalance] = useState('0');
  const [usdcBalance, setUsdcBalance] = useState('0');
  const [totalSupply, setTotalSupply] = useState('0');
  const [totalValue, setTotalValue] = useState('0');
  const [yieldGenerated, setYieldGenerated] = useState('0');
  const [inrRate, setInrRate] = useState('0');
  const [pricePerToken, setPricePerToken] = useState('0');
  
  // Form states
  const [mintAmount, setMintAmount] = useState('');
  const [burnAmount, setBurnAmount] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [activeTab, setActiveTab] = useState('mint');

  // Connect Wallet
  const connectWallet = async () => {
    try {
      setError('');
      if (typeof window.ethereum === 'undefined') {
        setError('Please install MetaMask!');
        return;
      }

      const { ethers } = window;
      if (!ethers) {
        setError('Ethers.js not loaded. Please refresh the page.');
        return;
      }

      const provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();
      const network = await provider.getNetwork();

      // Check if on Polygon
      if (network.chainId !== 137n) {
        setError('Please switch to Polygon network!');
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x89' }], // 137 in hex
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            setError('Please add Polygon network to MetaMask');
          }
          return;
        }
      }

      setAccount(accounts[0]);
      setProvider(provider);
      setSigner(signer);

      // Initialize contracts
      const binr = new ethers.Contract(BINR_ADDRESS, BINR_ABI, signer);
      const usdc = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
      
      setBinrContract(binr);
      setUsdcContract(usdc);

      setSuccess('Wallet connected!');
      setTimeout(() => setSuccess(''), 3000);
    } catch (err) {
      console.error(err);
      setError('Failed to connect wallet: ' + err.message);
    }
  };

  // Load data
  const loadData = async () => {
    if (!binrContract || !usdcContract || !account) return;

    try {
      const { ethers } = window;
      
      const [binrBal, usdcBal, supply, value, yield_, rate, price] = await Promise.all([
        binrContract.balanceOf(account),
        usdcContract.balanceOf(account),
        binrContract.totalSupply(),
        binrContract.getTotalValue(),
        binrContract.getYieldGenerated(),
        binrContract.getLatestPrice(),
        binrContract.pricePerTokenInUsdc()
      ]);

      setBinrBalance(ethers.formatUnits(binrBal, 18));
      setUsdcBalance(ethers.formatUnits(usdcBal, 6));
      setTotalSupply(ethers.formatUnits(supply, 18));
      setTotalValue(ethers.formatUnits(value, 6));
      setYieldGenerated(ethers.formatUnits(yield_, 6));
      
      // INR rate: convert from 8 decimals (USD per INR) to INR per USD
      const usdPerInr = Number(ethers.formatUnits(rate, 8));
      const inrPerUsd = 1 / usdPerInr;
      setInrRate(inrPerUsd.toFixed(2));
      
      setPricePerToken(ethers.formatUnits(price, 18));
    } catch (err) {
      console.error('Error loading data:', err);
    }
  };

  useEffect(() => {
    if (binrContract && account) {
      loadData();
      const interval = setInterval(loadData, 15000); // Refresh every 15s
      return () => clearInterval(interval);
    }
  }, [binrContract, account]);

  // Mint function
  const handleMint = async () => {
    if (!mintAmount || parseFloat(mintAmount) <= 0) {
      setError('Please enter a valid amount');
      return;
    }

    setLoading(true);
    setError('');
    setSuccess('');

    try {
      const { ethers } = window;
      const amount = ethers.parseUnits(mintAmount, 6);
      
      // Check allowance
      const allowance = await usdcContract.allowance(account, BINR_ADDRESS);
      
      if (allowance < amount) {
        setSuccess('Approving USDC...');
        const approveTx = await usdcContract.approve(BINR_ADDRESS, amount);
        await approveTx.wait();
        setSuccess('USDC approved! Now minting...');
      }

      // Mint with 1% slippage tolerance
      const minTokensOut = 0; // You can calculate based on rate
      const tx = await binrContract.mint(amount, minTokensOut);
      
      setSuccess('Transaction submitted! Waiting for confirmation...');
      await tx.wait();
      
      setSuccess('✅ Successfully minted BINR tokens!');
      setMintAmount('');
      await loadData();
    } catch (err) {
      console.error(err);
      setError('Mint failed: ' + (err.reason || err.message));
    } finally {
      setLoading(false);
    }
  };

  // Burn function
  const handleBurn = async () => {
    if (!burnAmount || parseFloat(burnAmount) <= 0) {
      setError('Please enter a valid amount');
      return;
    }

    setLoading(true);
    setError('');
    setSuccess('');

    try {
      const { ethers } = window;
      const amount = ethers.parseUnits(burnAmount, 18);
      
      // Burn with 1% slippage tolerance
      const minUsdcOut = 0; // You can calculate based on pricePerToken
      const tx = await binrContract.burn(amount, minUsdcOut);
      
      setSuccess('Transaction submitted! Waiting for confirmation...');
      await tx.wait();
      
      setSuccess('✅ Successfully burned BINR and received USDC!');
      setBurnAmount('');
      await loadData();
    } catch (err) {
      console.error(err);
      setError('Burn failed: ' + (err.reason || err.message));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="flex justify-between items-center mb-8 pt-6">
          <div>
            <h1 className="text-4xl font-bold mb-2">BINR Token</h1>
            <p className="text-purple-200">INR-Pegged Stablecoin on Polygon</p>
          </div>
          
          {!account ? (
            <button
              onClick={connectWallet}
              className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold transition"
            >
              <Wallet size={20} />
              Connect Wallet
            </button>
          ) : (
            <div className="text-right">
              <div className="text-sm text-purple-200 mb-1">Connected</div>
              <div className="bg-purple-800/50 px-4 py-2 rounded-lg font-mono text-sm">
                {account.slice(0, 6)}...{account.slice(-4)}
              </div>
            </div>
          )}
        </div>

        {/* Alerts */}
        {error && (
          <div className="bg-red-500/20 border border-red-500 rounded-lg p-4 mb-6 flex items-start gap-3">
            <AlertCircle className="flex-shrink-0 mt-0.5" size={20} />
            <div className="text-sm">{error}</div>
          </div>
        )}

        {success && (
          <div className="bg-green-500/20 border border-green-500 rounded-lg p-4 mb-6 flex items-start gap-3">
            <AlertCircle className="flex-shrink-0 mt-0.5" size={20} />
            <div className="text-sm">{success}</div>
          </div>
        )}

        {/* Stats Cards */}
        {account && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-white/10 backdrop-blur-lg rounded-lg p-4 border border-white/20">
              <div className="text-sm text-purple-200 mb-1">Your BINR Balance</div>
              <div className="text-2xl font-bold">{parseFloat(binrBalance).toFixed(2)}</div>
            </div>
            
            <div className="bg-white/10 backdrop-blur-lg rounded-lg p-4 border border-white/20">
              <div className="text-sm text-purple-200 mb-1">Your USDC Balance</div>
              <div className="text-2xl font-bold">{parseFloat(usdcBalance).toFixed(2)}</div>
            </div>
            
            <div className="bg-white/10 backdrop-blur-lg rounded-lg p-4 border border-white/20">
              <div className="text-sm text-purple-200 mb-1">INR/USD Rate</div>
              <div className="text-2xl font-bold">₹{inrRate}</div>
            </div>
            
            <div className="bg-white/10 backdrop-blur-lg rounded-lg p-4 border border-white/20">
              <div className="text-sm text-purple-200 mb-1">Total Supply</div>
              <div className="text-2xl font-bold">{parseFloat(totalSupply).toFixed(0)}</div>
            </div>
          </div>
        )}

        {/* Protocol Stats */}
        {account && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-lg rounded-lg p-4 border border-green-500/30">
              <div className="text-sm text-green-200 mb-1">Total Value Locked</div>
              <div className="text-2xl font-bold">${parseFloat(totalValue).toLocaleString()}</div>
            </div>
            
            <div className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20 backdrop-blur-lg rounded-lg p-4 border border-blue-500/30">
              <div className="text-sm text-blue-200 mb-1">Yield Generated</div>
              <div className="text-2xl font-bold">${parseFloat(yieldGenerated).toFixed(2)}</div>
            </div>
            
            <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-lg rounded-lg p-4 border border-purple-500/30">
              <div className="text-sm text-purple-200 mb-1">Price per Token</div>
              <div className="text-2xl font-bold">${parseFloat(pricePerToken).toFixed(6)}</div>
            </div>
          </div>
        )}

        {/* Main Card */}
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl border border-white/20 overflow-hidden">
          {/* Tabs */}
          <div className="flex border-b border-white/20">
            <button
              onClick={() => setActiveTab('mint')}
              className={`flex-1 px-6 py-4 font-semibold transition ${
                activeTab === 'mint'
                  ? 'bg-white/20 text-white'
                  : 'text-purple-200 hover:bg-white/5'
              }`}
            >
              <div className="flex items-center justify-center gap-2">
                <TrendingUp size={20} />
                Mint BINR
              </div>
            </button>
            
            <button
              onClick={() => setActiveTab('burn')}
              className={`flex-1 px-6 py-4 font-semibold transition ${
                activeTab === 'burn'
                  ? 'bg-white/20 text-white'
                  : 'text-purple-200 hover:bg-white/5'
              }`}
            >
              <div className="flex items-center justify-center gap-2">
                <ArrowDownUp size={20} />
                Burn BINR
              </div>
            </button>
          </div>

          {/* Content */}
          <div className="p-8">
            {!account ? (
              <div className="text-center py-12">
                <Wallet size={48} className="mx-auto mb-4 text-purple-300" />
                <p className="text-xl mb-2">Connect your wallet to get started</p>
                <p className="text-purple-200 text-sm">Trade USDC for INR-pegged BINR tokens</p>
              </div>
            ) : activeTab === 'mint' ? (
              <div>
                <div className="mb-6">
                  <label className="block text-sm text-purple-200 mb-2">
                    Amount of USDC to deposit
                  </label>
                  <div className="relative">
                    <input
                      type="number"
                      value={mintAmount}
                      onChange={(e) => setMintAmount(e.target.value)}
                      placeholder="0.00"
                      className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-4 text-2xl font-semibold focus:outline-none focus:border-purple-400 transition"
                      disabled={loading}
                    />
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 text-purple-200 font-semibold">
                      USDC
                    </div>
                  </div>
                  <div className="flex justify-between mt-2 text-sm text-purple-200">
                    <span>Balance: {parseFloat(usdcBalance).toFixed(2)} USDC</span>
                    <button
                      onClick={() => setMintAmount(usdcBalance)}
                      className="hover:text-white transition"
                    >
                      MAX
                    </button>
                  </div>
                </div>

                {mintAmount && (
                  <div className="bg-white/5 rounded-lg p-4 mb-6 border border-white/10">
                    <div className="text-sm text-purple-200 mb-1">You will receive approximately:</div>
                    <div className="text-2xl font-bold">
                      {(parseFloat(mintAmount) * parseFloat(inrRate) * 0.999).toFixed(2)} BINR
                    </div>
                    <div className="text-xs text-purple-300 mt-1">
                      (0.1% mint fee applied)
                    </div>
                  </div>
                )}

                <button
                  onClick={handleMint}
                  disabled={loading || !mintAmount}
                  className="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <>
                      <RefreshCw size={20} className="animate-spin" />
                      Processing...
                    </>
                  ) : (
                    'Mint BINR'
                  )}
                </button>
              </div>
            ) : (
              <div>
                <div className="mb-6">
                  <label className="block text-sm text-purple-200 mb-2">
                    Amount of BINR to burn
                  </label>
                  <div className="relative">
                    <input
                      type="number"
                      value={burnAmount}
                      onChange={(e) => setBurnAmount(e.target.value)}
                      placeholder="0.00"
                      className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-4 text-2xl font-semibold focus:outline-none focus:border-purple-400 transition"
                      disabled={loading}
                    />
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 text-purple-200 font-semibold">
                      BINR
                    </div>
                  </div>
                  <div className="flex justify-between mt-2 text-sm text-purple-200">
                    <span>Balance: {parseFloat(binrBalance).toFixed(2)} BINR</span>
                    <button
                      onClick={() => setBurnAmount(binrBalance)}
                      className="hover:text-white transition"
                    >
                      MAX
                    </button>
                  </div>
                </div>

                {burnAmount && pricePerToken && (
                  <div className="bg-white/5 rounded-lg p-4 mb-6 border border-white/10">
                    <div className="text-sm text-purple-200 mb-1">You will receive approximately:</div>
                    <div className="text-2xl font-bold">
                      {(parseFloat(burnAmount) * parseFloat(pricePerToken) * 0.999).toFixed(2)} USDC
                    </div>
                    <div className="text-xs text-purple-300 mt-1">
                      (0.1% burn fee applied, includes yield)
                    </div>
                  </div>
                )}

                <button
                  onClick={handleBurn}
                  disabled={loading || !burnAmount}
                  className="w-full bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed py-4 rounded-lg font-bold text-lg transition flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <>
                      <RefreshCw size={20} className="animate-spin" />
                      Processing...
                    </>
                  ) : (
                    'Burn BINR'
                  )}
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Info Footer */}
        <div className="mt-8 text-center text-sm text-purple-200">
          <p>BINR is pegged 1:1 with Indian Rupee (INR)</p>
          <p className="mt-1">Backed by USDC deposited in Aave • Yield distributed to holders</p>
        </div>
      </div>

      {/* Load ethers.js */}
      <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    </div>
  );
}
